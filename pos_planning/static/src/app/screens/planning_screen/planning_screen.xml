<?xml version="1.0" encoding="UTF-8" ?>
<templates id="template" xml:space="preserve">
    <t t-name="pos_planning.PlanningScreen">
        <div
            class="planning-screen screen h-100 d-flex flex-column bg-100"
            t-on-mousedown="() => state.showScaleDropdown = false"
        >
            <div
                class="top-content d-flex align-items-center p-2 border-bottom bg-view shadow-sm sticky-top"
            >
                <button
                    class="button back btn btn-lg btn-outline-secondary me-3 shadow-none"
                    t-on-click="() => this.back()"
                >
                    <i class="fa fa-angle-double-left me-1" /> Back
                </button>
                <div class="navigation-group d-flex align-items-center gap-1">
                    <button
                        class="btn btn-light border shadow-none"
                        t-on-click.stop="() => this.changeDate(-1)"
                    ><i class="fa fa-chevron-left" /></button>
                    <button
                        class="btn btn-light border shadow-none"
                        t-on-click.stop="() => this.changeDate(1)"
                    ><i class="fa fa-chevron-right" /></button>
                    <div class="dropdown ms-2 position-relative">
                        <button
                            class="btn btn-light border dropdown-toggle text-capitalize shadow-none"
                            type="button"
                            t-on-click.stop="() => this.toggleScaleDropdown()"
                        >
                            <t t-esc="state.scale" />
                        </button>
                        <div
                            class="dropdown-menu shadow-lg show p-1 border-0"
                            t-if="state.showScaleDropdown"
                            t-on-mousedown.stop=""
                            style="display: block; position: absolute; top: 100%; left: 0; min-width: 120px; z-index: 1000;"
                        >
                            <button
                                class="dropdown-item rounded py-2"
                                t-on-click.stop="() => this.setScale('day')"
                            >Day</button>
                            <button
                                class="dropdown-item rounded py-2"
                                t-on-click.stop="() => this.setScale('week')"
                            >Week</button>
                            <button
                                class="dropdown-item rounded py-2"
                                t-on-click.stop="() => this.setScale('month')"
                            >Month</button>
                        </div>
                    </div>
                    <button
                        class="btn btn-primary border-0 ms-2 px-3 fw-bold shadow-sm"
                        style="background-color: #714B67;"
                        t-on-click.stop="() => this.onClickCreate()"
                    >
                        Add Closing Day(s)
                    </button>
                    <button
                        class="btn btn-light border ms-2 shadow-none"
                        t-on-click.stop="() => this.setToday()"
                    >Today</button>
                    <button
                        class="btn btn-info ms-2 px-3 fw-bold text-white shadow-sm"
                        t-on-click.stop="() => this.pos.navigate('ShiftScreen')"
                    >
                        <i class="fa fa-clock-o me-1" /> Manage Shifts
                    </button>
                </div>
                <div
                    class="search-bar flex-grow-1 mx-4"
                    style="max-width: 500px;"
                >
                    <div class="input-group input-group-lg shadow-sm">
                        <span class="input-group-text bg-white border-0"><i
                                class="fa fa-search text-primary opacity-75"
                            /></span>
                        <input
                            type="text"
                            class="form-control border-0 ps-0 fs-6"
                            placeholder="Search Customer, Phone, Role, or Note..."
                            t-model="state.searchTerm"
                            t-on-input="() => this.groupSlots()"
                        />
                        <button
                            t-if="state.searchTerm"
                            class="btn btn-white border-0"
                            t-on-click="() => { state.searchTerm = ''; this.groupSlots(); }"
                        ><i class="fa fa-times text-muted" /></button>
                    </div>
                </div>
                <div class="top-right d-flex gap-2 ms-auto align-items-center">
                    <div class="d-flex flex-column align-items-end me-2">
                        <span
                            class="text-muted small fw-bold text-uppercase"
                            t-esc="state.scale"
                        />
                        <!-- Fix: Escaped dash -->
                        <span class="fw-bold text-dark small"><t
                                t-esc="state.startDate"
                            /> - <t t-esc="state.endDate" /></span>
                    </div>
                    <button
                        class="button create btn btn-lg btn-primary shadow-sm px-4"
                        t-on-click.stop="() => this.onClickCreate()"
                    >
                        <i class="fa fa-plus me-1" /> New
                    </button>
                </div>
            </div>
            <div class="content flex-grow-1 overflow-auto bg-white">
                <div
                    class="gantt-wrapper"
                    t-attf-style="min-width: {{state.scale === 'day' ? 2800 : 1400}}px;"
                >
                    <div
                        class="gantt-header d-flex bg-white sticky-top border-bottom shadow-sm"
                        style="top: 0; z-index: 105;"
                    >
                        <div
                            class="resource-col text-center d-flex align-items-center justify-content-center fw-bold border-end"
                            style="width: 200px; height: 50px;"
                        >Resources</div>
                        <div class="timeline-col flex-grow-1 d-flex">
                            <t
                                t-foreach="state.timelineLabels"
                                t-as="label"
                                t-key="label_index"
                            >
                                <div
                                    class="hour-slot border-end d-flex align-items-center justify-content-center small fw-bold"
                                    t-attf-style="width: {{100 / state.timelineLabels.length}}%; font-size: 11px; border-color: rgba(0,0,0,0.1) !important;"
                                >
                                    <span
                                        t-if="label"
                                        style="white-space: nowrap;"
                                        t-esc="label"
                                    />
                                </div>
                            </t>
                        </div>
                    </div>
                    <t t-foreach="state.resources" t-as="res" t-key="res.id">
                        <div class="gantt-row d-flex border-bottom">
                            <div
                                class="resource-col border-end p-2 d-flex align-items-center bg-white text-truncate shadow-sm-inset"
                                style="width: 200px; min-height: 75px;"
                            ><span
                                    class="ps-2 fw-medium text-dark"
                                    t-esc="res.name"
                                /></div>
                            <div
                                class="timeline-col flex-grow-1 position-relative gantt-grid"
                                t-on-mousedown="(ev) => this.onMouseDown(ev, 0, res.id)"
                                t-on-mousemove="(ev) => this.onMouseMove(ev)"
                                t-on-mouseup="() => this.onMouseUp()"
                            >
                                <div
                                    class="grid-lines position-absolute w-100 h-100 d-flex pointer-events-none"
                                >
                                    <t
                                        t-foreach="state.timelineLabels"
                                        t-as="l"
                                        t-key="l_index"
                                    >
                                        <div
                                            class="grid-line border-end h-100"
                                            t-attf-style="width: {{100 / state.timelineLabels.length}}%; border-color: rgba(0,0,0,0.1) !important;"
                                        />
                                    </t>
                                </div>
                                
                                <t t-foreach="state.groupedData" t-as="roleId" t-key="roleId">
                                    <t t-set="resource" t-value="state.groupedData[roleId].resources[res.id]"/>
                                    <t t-if="resource and resource.unavailable">
                                        <t t-foreach="resource.unavailable" t-as="ua" t-key="ua_index">
                                            <div class="gantt-unavailable-zone position-absolute h-100" t-att-style="ua.style"/>
                                        </t>
                                    </t>
                                </t>

                                <div
                                    t-if="state.isDragging and state.dragResourceId == res.id"
                                    class="gantt-drag-shadow position-absolute"
                                    t-att-style="this.getDragStyle()"
                                />
                                <t
                                    t-foreach="state.groupedData"
                                    t-as="roleId"
                                    t-key="roleId"
                                >
                                    <t
                                        t-set="resource"
                                        t-value="state.groupedData[roleId].resources[res.id]"
                                    />
                                    <t
                                        t-foreach="resource.overlaps"
                                        t-as="ov"
                                        t-key="ov_index"
                                    ><div
                                            class="gantt-overlap-marker position-absolute shadow-sm"
                                            t-att-style="ov.style"
                                        /></t>
                                    <t
                                        t-foreach="resource.slots"
                                        t-as="slot"
                                        t-key="slot.id"
                                    >
                                        <div
                                            class="gantt-pill position-absolute rounded-3 d-flex flex-column align-items-start justify-content-center text-white px-2 py-1 overflow-hidden shadow-sm"
                                            t-att-style="slot.ganttStyle"
                                            t-on-mousedown.stop=""
                                            t-on-click.stop="() => this.onClickSlot(slot)"
                                        >
                                            <div
                                                class="w-100 d-flex justify-content-between align-items-center"
                                            >
                                                <span
                                                    class="fw-bold text-truncate"
                                                    style="font-size: 11px;"
                                                    t-esc="slot.role_id ? slot.role_id[1] : 'No Role'"
                                                />
                                                <i
                                                    class="fa fa-clock-o opacity-75"
                                                    style="font-size: 9px;"
                                                />
                                            </div>
                                            <div
                                                class="text-truncate w-100 fw-bold"
                                                style="font-size: 11px;"
                                                t-esc="slot.partner_id ? slot.partner_id[1] : (slot.name || '')"
                                            />
                                            <t t-if="slot.phone">
                                                <div
                                                    class="w-100 text-truncate opacity-75"
                                                    style="font-size: 9px;"
                                                ><i
                                                        class="fa fa-phone me-1"
                                                    /> <t
                                                        t-esc="slot.phone"
                                                    /></div>
                                            </t>
                                        </div>
                                    </t>
                                </t>
                            </div>
                        </div>
                    </t>
                </div>
            </div>
        </div>
    </t>
</templates>
